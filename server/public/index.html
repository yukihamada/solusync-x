<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOLUSync-X</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      color: #fff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      width: 100%;
      text-align: center;
    }
    
    h1 {
      font-size: 4em;
      margin-bottom: 0.2em;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: glow 2s ease-in-out infinite alternate;
    }
    
    @keyframes glow {
      from { filter: brightness(1); }
      to { filter: brightness(1.2); }
    }
    
    .tagline {
      font-size: 1.2em;
      opacity: 0.8;
      margin-bottom: 2em;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 40px;
      margin-bottom: 30px;
    }
    
    .status {
      display: grid;
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .status-item {
      display: flex;
      justify-content: space-between;
      padding: 15px 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .status-label {
      opacity: 0.7;
    }
    
    .status-value {
      font-family: monospace;
      color: #4ecdc4;
      font-weight: bold;
    }
    
    .sync-visual {
      margin: 40px 0;
      position: relative;
      height: 200px;
    }
    
    .orbit {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 2px solid rgba(78, 205, 196, 0.2);
      border-radius: 50%;
    }
    
    .orbit1 { width: 100px; height: 100px; animation: rotate 3s linear infinite; }
    .orbit2 { width: 150px; height: 150px; animation: rotate 5s linear infinite reverse; }
    .orbit3 { width: 200px; height: 200px; animation: rotate 7s linear infinite; }
    
    @keyframes rotate {
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    .sync-core {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      background: radial-gradient(circle, #4ecdc4 0%, #45b3aa 100%);
      border-radius: 50%;
      box-shadow: 0 0 40px rgba(78, 205, 196, 0.8);
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.1); }
    }
    
    .buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 30px;
    }
    
    button {
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    button:hover::before {
      left: 100%;
    }
    
    .btn-primary {
      background: linear-gradient(45deg, #4ecdc4, #44a3aa);
      color: white;
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }
    
    button:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
      transform: none;
    }
    
    .log {
      margin-top: 30px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      padding: 20px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      text-align: left;
    }
    
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #4ecdc4;
      padding-left: 10px;
    }
    
    .features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-top: 40px;
    }
    
    .feature {
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .feature-icon {
      font-size: 2em;
      margin-bottom: 10px;
    }
    
    .feature-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .feature-desc {
      font-size: 0.9em;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>SOLUSync-X</h1>
    <p class="tagline">Next-Generation Synchronization Protocol</p>
    
    <div class="card">
      <div class="sync-visual">
        <div class="orbit orbit1"></div>
        <div class="orbit orbit2"></div>
        <div class="orbit orbit3"></div>
        <div class="sync-core"></div>
      </div>
      
      <div class="status">
        <div class="status-item">
          <span class="status-label">Connection Status</span>
          <span class="status-value" id="connection">Disconnected</span>
        </div>
        <div class="status-item">
          <span class="status-label">Server Time</span>
          <span class="status-value" id="serverTime">--:--:--</span>
        </div>
        <div class="status-item">
          <span class="status-label">Clock Offset</span>
          <span class="status-value" id="clockOffset">-- ms</span>
        </div>
        <div class="status-item">
          <span class="status-label">Network Quality</span>
          <span class="status-value" id="quality">Unknown</span>
        </div>
      </div>
      
      <div class="buttons">
        <button id="connectBtn" class="btn-primary">Connect</button>
        <button id="disconnectBtn" class="btn-secondary" disabled>Disconnect</button>
        <button id="playBtn" class="btn-secondary" disabled>Test Play</button>
        <button id="syncBtn" class="btn-secondary" disabled>Force Sync</button>
        <button id="clientsBtn" class="btn-secondary">Show Clients</button>
      </div>
      
      <div class="log" id="log"></div>
    </div>
    
    <div class="features">
      <div class="feature">
        <div class="feature-icon">‚ö°</div>
        <div class="feature-title">Ultra-Low Latency</div>
        <div class="feature-desc">¬±0.5ms sync accuracy</div>
      </div>
      <div class="feature">
        <div class="feature-icon">üåê</div>
        <div class="feature-title">1000+ Devices</div>
        <div class="feature-desc">Massive scalability</div>
      </div>
      <div class="feature">
        <div class="feature-icon">üîÑ</div>
        <div class="feature-title">Self-Healing</div>
        <div class="feature-desc">Auto failover</div>
      </div>
    </div>
  </div>

  <script type="module">
    // Import from built client library
    const serverUrl = window.location.origin;
    
    // UUID v4 generator
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    
    class SoluSyncDemo {
      constructor() {
        this.ws = null;
        this.connected = false;
        this.nodeId = generateUUID();
        this.sequence = 0;
        this.clockOffset = 0;
        this.lastRtt = 0;
      }
      
      async connect() {
        return new Promise((resolve, reject) => {
          const wsUrl = serverUrl.replace('http', 'ws') + '/ws';
          this.ws = new WebSocket(wsUrl);
          
          this.ws.onopen = () => {
            this.connected = true;
            this.sendHello();
            this.startHeartbeat();
            this.startClockSync();
            this.log('Connected to SOLUSync-X server');
            resolve();
          };
          
          this.ws.onmessage = (event) => {
            this.handleMessage(event.data);
          };
          
          this.ws.onerror = (error) => {
            this.log('Connection error: ' + error, 'error');
            reject(error);
          };
          
          this.ws.onclose = () => {
            this.connected = false;
            this.stopHeartbeat();
            this.stopClockSync();
            this.log('Disconnected from server');
            this.updateUI();
          };
        });
      }
      
      disconnect() {
        if (this.ws) {
          this.ws.close();
        }
      }
      
      sendHello() {
        const message = {
          type: 'hello',
          header: this.createHeader(),
          protocol_version: '0.1.0',
          capabilities: ['audio', 'clock_sync'],
          node_type: 'Client'
        };
        this.send(message);
      }
      
      handleMessage(data) {
        try {
          const message = JSON.parse(data);
          
          switch (message.type) {
            case 'hello':
              this.log('Server handshake completed');
              this.updateUI();
              break;
              
            case 'clock_sync_response':
              this.handleClockSync(message);
              break;
              
            case 'heartbeat':
              if (message.server_time) {
                const rtt = Date.now() / 1000 - message.client_time;
                const offset = message.server_time - Date.now() / 1000 + rtt / 2;
                this.clockOffset = offset * 1000;
                this.lastRtt = rtt * 1000;
              }
              break;
          }
        } catch (error) {
          console.error('Message handling error:', error);
        }
      }
      
      startClockSync() {
        this.clockSyncInterval = setInterval(() => {
          this.sendClockSync();
        }, 1000);
        this.sendClockSync();
      }
      
      stopClockSync() {
        if (this.clockSyncInterval) {
          clearInterval(this.clockSyncInterval);
        }
      }
      
      sendClockSync() {
        const t1 = Date.now() / 1000;
        const message = {
          type: 'clock_sync',
          header: this.createHeader(),
          t1: t1
        };
        this.syncT1 = t1;
        this.send(message);
      }
      
      handleClockSync(response) {
        const t4 = Date.now() / 1000;
        const t1 = this.syncT1;
        const t2 = response.t2;
        const t3 = response.t3;
        
        this.lastRtt = ((t4 - t1) - (t3 - t2)) * 1000;
        this.clockOffset = ((t2 - t1) + (t3 - t4)) / 2 * 1000;
        
        this.updateUI();
      }
      
      startHeartbeat() {
        this.heartbeatInterval = setInterval(() => {
          const message = {
            type: 'heartbeat',
            header: this.createHeader(),
            client_time: Date.now() / 1000
          };
          this.send(message);
        }, 5000);
      }
      
      stopHeartbeat() {
        if (this.heartbeatInterval) {
          clearInterval(this.heartbeatInterval);
        }
      }
      
      play() {
        const message = {
          type: 'media_control',
          header: this.createHeader(),
          action: 'play',
          track_id: 'demo_track',
          start_at: this.getServerTime() + 1.0,
          params: { volume: 0.8 }
        };
        this.send(message);
        this.log('Sent play command');
      }
      
      send(message) {
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
          this.ws.send(JSON.stringify(message));
        }
      }
      
      createHeader() {
        return {
          id: generateUUID(),
          timestamp: Date.now() / 1000,
          node_id: this.nodeId,
          sequence: this.sequence++
        };
      }
      
      getServerTime() {
        return Date.now() / 1000 + this.clockOffset / 1000;
      }
      
      getNetworkQuality() {
        if (this.lastRtt < 10) return 'Excellent';
        if (this.lastRtt < 50) return 'Good';
        if (this.lastRtt < 100) return 'Fair';
        if (this.lastRtt < 200) return 'Poor';
        return 'Critical';
      }
      
      log(message, type = 'info') {
        const logEl = document.getElementById('log');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logEl.appendChild(entry);
        logEl.scrollTop = logEl.scrollHeight;
        
        // Keep only last 10 entries
        while (logEl.children.length > 10) {
          logEl.removeChild(logEl.firstChild);
        }
      }
      
      updateUI() {
        const connectionEl = document.getElementById('connection');
        const serverTimeEl = document.getElementById('serverTime');
        const clockOffsetEl = document.getElementById('clockOffset');
        const qualityEl = document.getElementById('quality');
        
        if (this.connected) {
          connectionEl.textContent = 'Connected';
          connectionEl.style.color = '#52d98a';
          clockOffsetEl.textContent = this.clockOffset.toFixed(3) + ' ms';
          qualityEl.textContent = this.getNetworkQuality();
          
          document.getElementById('connectBtn').disabled = true;
          document.getElementById('disconnectBtn').disabled = false;
          document.getElementById('playBtn').disabled = false;
          document.getElementById('syncBtn').disabled = false;
        } else {
          connectionEl.textContent = 'Disconnected';
          connectionEl.style.color = '#ff6b6b';
          clockOffsetEl.textContent = '-- ms';
          qualityEl.textContent = 'Unknown';
          
          document.getElementById('connectBtn').disabled = false;
          document.getElementById('disconnectBtn').disabled = true;
          document.getElementById('playBtn').disabled = true;
          document.getElementById('syncBtn').disabled = true;
        }
      }
    }
    
    // Initialize
    const client = new SoluSyncDemo();
    
    // Update time display
    setInterval(() => {
      const serverTimeEl = document.getElementById('serverTime');
      if (client.connected) {
        const serverTime = new Date(client.getServerTime() * 1000);
        serverTimeEl.textContent = serverTime.toLocaleTimeString() + '.' + 
          String(serverTime.getMilliseconds()).padStart(3, '0');
      } else {
        serverTimeEl.textContent = '--:--:--';
      }
    }, 100);
    
    // Event handlers
    document.getElementById('connectBtn').addEventListener('click', async () => {
      try {
        await client.connect();
        client.updateUI();
      } catch (error) {
        client.log('Failed to connect', 'error');
      }
    });
    
    document.getElementById('disconnectBtn').addEventListener('click', () => {
      client.disconnect();
    });
    
    document.getElementById('playBtn').addEventListener('click', () => {
      client.play();
    });
    
    document.getElementById('syncBtn').addEventListener('click', () => {
      client.sendClockSync();
      client.log('Manual sync triggered');
    });
    
    document.getElementById('clientsBtn').addEventListener('click', async () => {
      try {
        const response = await fetch('/api/clients');
        const result = await response.json();
        
        if (result.success && result.data) {
          client.log('Connected clients: ' + result.data.length);
          result.data.forEach(cl => {
            const connectedAt = new Date(cl.connected_at).toLocaleTimeString();
            client.log(`- ${cl.client_id} (${cl.node_type}) from ${cl.remote_addr || 'unknown'} at ${connectedAt}`);
          });
        } else {
          client.log('Failed to get client list');
        }
      } catch (error) {
        client.log('Error fetching client list: ' + error.message);
      }
    });
    
    // Initial UI state
    client.updateUI();
    client.log('SOLUSync-X Demo Ready');
  </script>
</body>
</html>